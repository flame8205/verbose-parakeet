<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>StockFocus Pro - Ê∑±Â∫¶Ë≤°Â†±Ë∂®Âã¢Áâà</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,1,0" rel="stylesheet"/>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        .text-up { color: #dc2626; }
        .text-down { color: #16a34a; }
        .bg-up-light { background-color: #fef2f2; }
        .bg-down-light { background-color: #f0fdf4; }
        .fade-in { animation: fadeIn 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .spin-slow { animation: spin 3s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .score-badge { background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%); color: white; box-shadow: 0 4px 10px rgba(124, 58, 237, 0.3); }
        .tag-base { @apply px-2 py-0.5 rounded text-[10px] font-bold mr-1 border; }
        .tag-expansion { background-color: #eff6ff; color: #2563eb; border-color: #bfdbfe; }
        .tag-tech { background-color: #f5f3ff; color: #7c3aed; border-color: #ddd6fe; }
        .tag-order { background-color: #fff7ed; color: #ea580c; border-color: #fed7aa; }
        .tag-us { background-color: #fef2f2; color: #dc2626; border-color: #fecaca; }
        .tag-financial { background-color: #f0fdf4; color: #16a34a; border-color: #bbf7d0; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 20px; }
    </style>
</head>
<body class="h-screen flex overflow-hidden text-slate-800">
<aside class="w-72 bg-white border-r border-slate-200 flex flex-col z-20 shadow-xl hidden md:flex transition-all">
    <div class="p-5 border-b border-slate-100 flex items-center gap-3 bg-slate-50">
        <div class="w-10 h-10 bg-indigo-600 rounded-xl flex items-center justify-center text-white shadow-lg shadow-indigo-200">
            <span class="material-symbols-outlined text-2xl">waterfall_chart</span>
        </div>
        <div>
            <h1 class="font-bold text-lg text-slate-900 tracking-tight">StockFocus</h1>
            <p class="text-[10px] text-slate-500 font-medium uppercase tracking-wider">Pro Analytics</p>
        </div>
    </div>
    <div class="px-4 py-4 flex-1 overflow-y-auto custom-scroll">
        <div class="flex justify-between items-center mb-3 px-2">
            <h2 class="text-xs font-bold text-slate-400 uppercase tracking-wider">Áõ£ÊéßÊ∏ÖÂñÆ</h2>
            <span class="text-[10px] text-slate-400" id="last-update">--:--</span>
        </div>
        <div class="space-y-2" id="watchlist-container"></div>
    </div>
    <div class="p-4 bg-slate-50 border-t border-slate-200 text-[10px] text-slate-400 text-center leading-relaxed">
        Data via FinMind API<br/>
        <span class="text-indigo-500 font-bold">Margin & Rule of 40</span>
    </div>
</aside>
<main class="flex-1 flex flex-col min-w-0 bg-[#f8fafc] relative">
    <div class="md:hidden bg-white p-4 border-b flex justify-between items-center sticky top-0 z-30">
        <span class="font-bold text-lg">StockFocus</span>
        <button class="p-2" onclick="document.querySelector('aside').classList.toggle('hidden');"><span class="material-symbols-outlined">menu</span></button>
    </div>
    <header class="bg-white/90 backdrop-blur border-b border-slate-200 px-6 py-3 flex flex-col md:flex-row justify-between items-center sticky top-0 z-10 gap-3">
        <div class="relative w-full md:w-96 group">
            <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 group-focus-within:text-indigo-500 transition-colors">search</span>
            <input class="w-full pl-10 pr-4 py-2 bg-slate-100 border-transparent focus:bg-white border focus:border-indigo-500 rounded-lg text-sm focus:outline-none focus:ring-4 focus:ring-indigo-50 transition-all font-mono" id="stock-search" onkeydown="if(event.key === 'Enter') handleAddStock(this.value)" placeholder="Ëº∏ÂÖ•‰ª£Ëôü (Â¶Ç 2330)..." type="text"/>
        </div>
        <div class="flex items-center gap-2" id="status-bar"></div>
    </header>
    <div class="flex-1 overflow-y-auto p-4 md:p-8 custom-scroll" id="content-area">
        <div class="max-w-7xl mx-auto space-y-6 fade-in">
            <div class="bg-white rounded-2xl p-6 border border-slate-200 shadow-sm flex flex-col md:flex-row md:items-end justify-between gap-6">
                <div>
                    <div class="flex items-center gap-3">
                        <h2 class="text-4xl font-bold text-slate-900 tracking-tight font-mono" id="header-id">--</h2>
                        <span class="px-3 py-1 bg-slate-100 text-slate-600 rounded-lg text-base font-bold" id="header-name">ËÆÄÂèñ‰∏≠...</span>
                    </div>
                    <p class="text-slate-500 text-xs mt-2 flex items-center gap-1 font-mono">
                        <span class="material-symbols-outlined text-xs">update</span> DATE: <span id="header-date">--</span>
                    </p>
                </div>
                <div class="text-right">
                    <div class="flex items-center justify-end gap-3">
                        <span class="text-5xl font-bold font-mono tracking-tighter" id="header-price">--</span>
                        <div class="flex flex-col items-end">
                            <span class="text-lg font-bold flex items-center" id="header-change">--</span>
                            <span class="text-sm font-medium px-2 py-0.5 rounded" id="header-pct">--</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="bg-white p-5 rounded-2xl border border-slate-200 shadow-sm hover:shadow-md transition-shadow group relative overflow-hidden">
                    <div class="relative z-10">
                        <p class="text-xs text-slate-500 font-bold uppercase mb-2 tracking-wide">Á¥ØË®àÁáüÊî∂Âπ¥Â¢ûÁéá (YoY)</p>
                        <p class="text-3xl font-bold text-slate-800 font-mono tracking-tight" id="fin-acc-yoy">--</p>
                        <div class="mt-2 text-xs text-slate-400 font-mono">Jan - <span id="fin-acc-range">--</span> (YTD)</div>
                    </div>
                    <div class="absolute -right-6 -bottom-6 w-24 h-24 bg-blue-50 rounded-full z-0"></div>
                </div>
                <div class="bg-white p-5 rounded-2xl border border-slate-200 shadow-sm hover:shadow-md transition-shadow group relative overflow-hidden ring-1 ring-inset ring-slate-100">
                    <div class="relative z-10">
                        <div class="flex justify-between items-start mb-1">
                            <p class="text-xs text-slate-500 font-bold uppercase tracking-wide">ÊúÄÊñ∞ÊØõÂà©Áéá</p>
                            <span class="text-[10px] bg-orange-50 text-orange-600 px-1.5 py-0.5 rounded font-bold font-mono" id="fin-margin-q">--</span>
                        </div>
                        <p class="text-3xl font-bold text-slate-800 font-mono tracking-tight" id="fin-margin">--</p>
                        <div class="mt-3 bg-slate-50 rounded-lg p-2 flex items-center justify-between text-xs border border-slate-100">
                            <span class="text-slate-500">Êú¨Âπ¥Â∫¶Á¥ØË®àÊàêÈï∑<br/>Q1 <span class="material-symbols-outlined text-[10px] align-middle">arrow_right_alt</span> <span id="fin-margin-target-q">--</span></span>
                            <div class="text-right">
                                <span class="font-bold text-sm block" id="fin-margin-ytd-growth">--</span>
                                <span class="text-[9px] text-slate-400" id="fin-margin-trend-val">--</span>
                            </div>
                        </div>
                    </div>
                    <div class="absolute -right-6 -bottom-6 w-24 h-24 bg-orange-50 rounded-full z-0 opacity-50"></div>
                </div>
                <div class="bg-white p-5 rounded-2xl border border-slate-200 shadow-sm hover:shadow-md transition-shadow group relative overflow-hidden">
                    <div class="relative z-10">
                        <div class="flex justify-between items-start mb-2">
                            <p class="text-xs text-slate-500 font-bold uppercase tracking-wide">Rule of 40 ÊåáÊ®ô</p>
                            <span class="hidden text-[10px] px-2 py-0.5 rounded-full font-bold shadow-sm score-badge animate-pulse" id="score-badge">High Quality</span>
                        </div>
                        <p class="text-3xl font-bold text-slate-800 font-mono tracking-tight" id="fin-score">--</p>
                        <div class="mt-2 text-xs text-slate-400">(Á¥ØË®àÁáüÊî∂ÊàêÈï∑ + ÊØõÂà©Áéá) > 40</div>
                    </div>
                    <div class="absolute -right-6 -bottom-6 w-24 h-24 bg-indigo-50 rounded-full z-0"></div>
                </div>
                <div class="bg-white p-5 rounded-2xl border border-slate-200 shadow-sm hover:shadow-md transition-shadow group relative overflow-hidden">
                    <div class="relative z-10">
                        <div class="flex justify-between items-start mb-2">
                            <p class="text-xs text-slate-500 font-bold uppercase tracking-wide">ÊúÄÊñ∞ÊúàÁáüÊî∂</p>
                            <span class="text-[10px] bg-emerald-50 text-emerald-600 px-1.5 py-0.5 rounded font-bold font-mono" id="fin-rev-month">--</span>
                        </div>
                        <p class="text-2xl font-bold text-slate-800 font-mono" id="fin-revenue">--</p>
                        <div class="mt-2 flex items-center gap-3 text-xs font-mono">
                            <div><span class="text-slate-400 block text-[9px]">MoM</span><span class="font-bold" id="fin-rev-mom">--</span></div>
                            <div class="w-px h-6 bg-slate-100"></div>
                            <div><span class="text-slate-400 block text-[9px]">YoY</span><span class="font-bold" id="fin-rev-yoy">--</span></div>
                        </div>
                    </div>
                    <div class="absolute -right-6 -bottom-6 w-24 h-24 bg-emerald-50 rounded-full z-0"></div>
                </div>
            </div>
            <section class="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden flex flex-col min-h-[500px]">
                <div class="px-6 py-4 border-b border-slate-100 bg-slate-50/50">
                    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                        <div class="flex items-center gap-2">
                            <span class="material-symbols-outlined text-indigo-600">newspaper</span>
                            <div>
                                <h3 class="font-bold text-slate-800">Êô∫ÊÖßÊñ∞ËÅûÁØ©ÈÅ∏</h3>
                                <p class="text-[10px] text-slate-500">Auto-tagging</p>
                            </div>
                        </div>
                        <div class="flex flex-wrap gap-2" id="filter-container">
                            <button class="px-3 py-1.5 rounded-lg text-xs font-bold transition-all bg-slate-800 text-white shadow-md scale-105" onclick="filterNews('all', this)">All</button>
                            <button class="px-3 py-1.5 rounded-lg text-xs font-bold transition-all bg-white text-slate-600 border border-slate-200 hover:border-blue-300 hover:text-blue-600" onclick="filterNews('expansion', this)">üè≠ Êì¥Âª†</button>
                            <button class="px-3 py-1.5 rounded-lg text-xs font-bold transition-all bg-white text-slate-600 border border-slate-200 hover:border-purple-300 hover:text-purple-600" onclick="filterNews('tech', this)">‚ö° ÊäÄË°ì</button>
                            <button class="px-3 py-1.5 rounded-lg text-xs font-bold transition-all bg-white text-slate-600 border border-slate-200 hover:border-orange-300 hover:text-orange-600" onclick="filterNews('order', this)">üì¶ Ë®ÇÂñÆ</button>
                            <button class="px-3 py-1.5 rounded-lg text-xs font-bold transition-all bg-white text-slate-600 border border-slate-200 hover:border-red-300 hover:text-red-600" onclick="filterNews('us', this)">üá∫üá∏ ÁæéÂïÜ</button>
                            <button class="px-3 py-1.5 rounded-lg text-xs font-bold transition-all bg-white text-slate-600 border border-slate-200 hover:border-green-300 hover:text-green-600" onclick="filterNews('financial', this)">üí∞ Ë≤°Â†±</button>
                        </div>
                    </div>
                </div>
                <div class="flex-1 bg-slate-50/30 overflow-y-auto max-h-[600px] p-2" id="news-list"></div>
            </section>
        </div>
    </div>
</main>
<script>
    const KEYWORDS = {
        expansion: { label: "Êì¥Âª†ÂãïÊÖã", color: "tag-expansion", regex: /(Êì¥Âª†|Âª∫Âª†|Êì¥Áî¢|Êñ∞Âª†|Ë®≠Âª†|Áî¢ËÉΩ|Âü∫Âú∞|ÂãïÂúü|Êì¥ÂÖÖ|Êì¥Âª∫)/i },
        tech: { label: "Êñ∞ÊäÄË°ì", color: "tag-tech", regex: /(Êñ∞ÊäÄË°ì|ÂÖàÈÄ≤Ë£ΩÁ®ã|Á†îÁôº|Â∞àÂà©|CoWoS|Â•àÁ±≥|Â∞ÅË£ù|AIÊô∂Áâá|ÊäÄË°ìÁ™ÅÁ†¥|ÂâµÊñ∞)/i },
        order: { label: "Ë®ÇÂñÆÈáè", color: "tag-order", regex: /(Ë®ÇÂñÆ|ÊãâË≤®|Âá∫Ë≤®|ÈúÄÊ±Ç|Â∫´Â≠ò|ËÉΩË¶ãÂ∫¶|ÊªøËºâ|ÊÄ•ÂñÆ|‰æõÊáâÈèà|Èä∑Èáè)/i },
        us: { label: "ÁæéÂïÜÂêà‰Ωú", color: "tag-us", regex: /(ÁæéÂúã|ÁæéÂïÜ|ËºùÈÅî|NVIDIA|ËòãÊûú|Apple|AMD|Intel|Ëã±ÁâπÁàæ|ÂæÆËªü|Microsoft|Google|AWS|Meta|‰∫ûÈ¶¨ÈÅú|ÁâπÊñØÊãâ|Tesla)/i },
        financial: { label: "Ë≤°Â†±ÁáüÊî∂", color: "tag-financial", regex: /(Ë≤°Â†±|ÁáüÊî∂|Áç≤Âà©|EPS|ÊØõÂà©|ËÇ°Âà©|Ê≥ïË™™ÊúÉ|ÁõàÈ§ò|Â≠£Â†±|Âπ¥Â†±|ÊúàÂ¢û|Âπ¥Â¢û|‰∏âÁéá)/i }
    };
    let stockNames = { "2330": "Âè∞Á©çÈõª", "2317": "È¥ªÊµ∑", "2454": "ËÅØÁôºÁßë", "2382": "Âª£ÈÅî" };
    let watchlist = ["2330", "2317", "2454", "2382"];
    let currentStockId = "2330";
    let processedNews = [];
    const FM_URL = "https://api.finmindtrade.com/api/v4/data";

    document.addEventListener("DOMContentLoaded", () => {
        renderWatchlist();
        loadStock(currentStockId);
        setInterval(() => loadStock(currentStockId), 60000);
    });

    async function loadStock(id) {
        currentStockId = id;
        updateStatus("Syncing...", "sync", "spin-slow");
        if (!stockNames[id] || stockNames[id] === id) {
            document.getElementById("header-name").innerText = "ËÆÄÂèñ‰∏≠...";
            await fetchStockName(id);
        }
        renderWatchlist();
        try {
            const today = new Date();
            const d730 = new Date(today); d730.setDate(today.getDate() - 730);
            const d60 = new Date(today); d60.setDate(today.getDate() - 60);
            const [priceRes, newsRes, revRes, finRes] = await Promise.allSettled([
                fetch(`${FM_URL}?dataset=TaiwanStockPrice&data_id=${id}&start_date=${d60.toISOString().split('T')[0]}`),
                fetch(`${FM_URL}?dataset=TaiwanStockNews&data_id=${id}&start_date=${new Date(today.getTime() - 45*24*60*60*1000).toISOString().split('T')[0]}`),
                fetch(`${FM_URL}?dataset=TaiwanStockMonthRevenue&data_id=${id}&start_date=${d730.toISOString().split('T')[0]}`),
                fetch(`${FM_URL}?dataset=TaiwanStockFinancialStatements&data_id=${id}&start_date=${d730.toISOString().split('T')[0]}`)
            ]);
            const priceData = await getJson(priceRes);
            const newsData = await getJson(newsRes);
            const revData = await getJson(revRes);
            const finData = await getJson(finRes);
            if (priceData?.data?.length > 0) {
                renderHeader(id, priceData.data);
                renderFinancials(revData, finData);
                analyzeAndRenderNews(newsData?.data || []);
                const now = new Date();
                document.getElementById("last-update").innerText = `${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}`;
                updateStatus("Connected", "check_circle", "text-green-600");
            } else { throw new Error("No Data"); }
        } catch (e) {
            console.error(e);
            updateStatus("Simulation Mode", "error", "text-orange-500");
            loadMockData(id);
        }
    }

    async function fetchStockName(id) {
        try {
            const res = await fetch(`${FM_URL}?dataset=TaiwanStockInfo&data_id=${id}`);
            const json = await res.json();
            if (json.data && json.data.length > 0) stockNames[id] = json.data[0].stock_name;
        } catch { }
    }

    function renderFinancials(revJson, finJson) {
        let accRevYoYVal = null;
        let grossMarginVal = null;
        if (revJson?.data?.length > 0) {
            const data = revJson.data;
            const cur = data[data.length - 1];
            const prevM = data.length > 1 ? data[data.length - 2] : null;
            const prevY = data.find(d => d.date === getSameMonthLastYear(cur.date));
            document.getElementById("fin-revenue").innerText = (cur.revenue / 100000000).toFixed(2) + " ÂÑÑ";
            document.getElementById("fin-rev-month").innerText = cur.date.slice(5, 7) + "Êúà";
            formatChange("fin-rev-mom", prevM ? ((cur.revenue - prevM.revenue) / prevM.revenue * 100).toFixed(1) : "--");
            formatChange("fin-rev-yoy", prevY ? ((cur.revenue - prevY.revenue) / prevY.revenue * 100).toFixed(1) : "--");
            const yearPrefix = cur.date.split('-')[0];
            const lastYearPrefix = (parseInt(yearPrefix) - 1).toString();
            const curSum = data.filter(d => d.date.startsWith(yearPrefix) && d.date <= cur.date).reduce((a, b) => a + b.revenue, 0);
            const lastYearLimit = `${lastYearPrefix}-${cur.date.split('-')[1]}`;
            const lastSum = data.filter(d => d.date.startsWith(lastYearPrefix) && d.date <= lastYearLimit + "-31").reduce((a, b) => a + b.revenue, 0);
            if (lastSum > 0) {
                const val = ((curSum - lastSum) / lastSum * 100);
                accRevYoYVal = val;
                const el = document.getElementById("fin-acc-yoy");
                el.innerText = (val > 0 ? "+" : "") + val.toFixed(2) + "%";
                el.className = `text-3xl font-bold font-mono tracking-tight ${val >= 0 ? 'text-up' : 'text-down'}`;
                document.getElementById("fin-acc-range").innerText = parseInt(cur.date.split('-')[1]);
            } else resetFin("fin-acc-yoy");
        } else { resetFin("fin-revenue"); resetFin("fin-acc-yoy"); }

        if (finJson?.data?.length > 0) {
            const margins = finJson.data.filter(d => d.type === "GrossProfitMargin");
            if (margins.length > 0) {
                margins.sort((a, b) => new Date(a.date) - new Date(b.date));
                const latest = margins[margins.length - 1];
                grossMarginVal = parseFloat(latest.value);
                document.getElementById("fin-margin").innerText = latest.value + "%";
                document.getElementById("fin-margin-q").innerText = getQuarterStr(latest.date);
                const currentYear = latest.date.split('-')[0];
                const q1 = margins.find(d => d.date.startsWith(currentYear) && d.date.includes("-03-"));
                if (q1 && latest.date !== q1.date) {
                    const diff = (parseFloat(latest.value) - parseFloat(q1.value)).toFixed(2);
                    const el = document.getElementById("fin-margin-ytd-growth");
                    el.innerText = (diff > 0 ? "‚ñ≤" : "‚ñº") + " " + Math.abs(diff) + "%";
                    el.className = `font-bold text-sm block ${diff >= 0 ? 'text-up' : 'text-down'}`;
                    document.getElementById("fin-margin-target-q").innerText = getQuarterStr(latest.date);
                    document.getElementById("fin-margin-trend-val").innerText = `${q1.value}% ‚Üí ${latest.value}%`;
                } else if (q1 && latest.date === q1.date) {
                    document.getElementById("fin-margin-ytd-growth").innerText = "Q1 Ëµ∑Âßã";
                    document.getElementById("fin-margin-ytd-growth").className = "font-bold text-sm block text-slate-500";
                    document.getElementById("fin-margin-trend-val").innerText = "Á≠âÂæÖ Q2";
                    document.getElementById("fin-margin-target-q").innerText = "Q1";
                } else resetFin("fin-margin-ytd-growth");
            } else resetFin("fin-margin");
        } else resetFin("fin-margin");

        const badge = document.getElementById("score-badge");
        if (accRevYoYVal !== null && grossMarginVal !== null) {
            const score = accRevYoYVal + grossMarginVal;
            const el = document.getElementById("fin-score");
            el.innerText = score.toFixed(1);
            el.className = `text-3xl font-bold font-mono tracking-tight ${score >= 40 ? 'text-indigo-600' : 'text-slate-800'}`;
            if (score >= 40) {
                badge.classList.remove("hidden");
                badge.innerText = `ÈÅîÊ®ô (${score.toFixed(0)})`;
            } else { badge.classList.add("hidden"); }
        } else {
            document.getElementById("fin-score").innerText = "--";
            badge.classList.add("hidden");
        }
    }

    function analyzeAndRenderNews(rawData) {
        processedNews = rawData.reverse().map(item => {
            const text = (item.title + item.description).toLowerCase();
            const tags = [];
            for (const [key, config] of Object.entries(KEYWORDS)) {
                if (config.regex.test(text)) tags.push(key);
            }
            return { ...item, tags };
        });
        filterNews('all', document.querySelector('#filter-container button'));
    }

    function filterNews(type, btn) {
        document.querySelectorAll('#filter-container button').forEach(b => {
            b.className = "px-3 py-1.5 rounded-lg text-xs font-bold transition-all bg-white text-slate-600 border border-slate-200 hover:border-blue-300";
        });
        if(btn) btn.className = "px-3 py-1.5 rounded-lg text-xs font-bold transition-all bg-slate-800 text-white shadow-md scale-105";
        const data = type === 'all' ? processedNews : processedNews.filter(n => n.tags.includes(type));
        const c = document.getElementById("news-list");
        c.innerHTML = "";
        if (data.length === 0) {
            c.innerHTML = `<div class="p-12 text-center text-slate-400">ÁÑ°Áõ∏ÈóúÊñ∞ËÅû</div>`;
            return;
        }
        data.forEach(item => {
            const tagsHtml = item.tags.map(t => `<span class="${KEYWORDS[t].color} px-2 py-0.5 rounded text-[10px] font-bold mr-1">${KEYWORDS[t].label}</span>`).join('');
            const div = document.createElement("div");
            div.className = "p-5 border-b border-slate-100 hover:bg-white transition-colors cursor-pointer group";
            div.onclick = () => window.open(item.link, '_blank');
            div.innerHTML = `
                <div class="flex justify-between items-start mb-1">
                    <div class="flex items-center gap-2 text-xs text-slate-500">
                        <span class="bg-slate-100 px-1.5 rounded">${item.source}</span>
                        <span>${item.date}</span>
                    </div>
                    <div class="flex">${tagsHtml}</div>
                </div>
                <h4 class="text-base font-bold text-slate-800 group-hover:text-indigo-600 transition-colors">${item.title}</h4>
                <p class="text-xs text-slate-500 line-clamp-2 mt-1">${item.description || ''}</p>
            `;
            c.appendChild(div);
        });
    }

    function renderHeader(id, data) {
        const latest = data[data.length - 1];
        const prev = data.length > 1 ? data[data.length - 2] : latest;
        const change = latest.close - prev.close;
        const pct = (change / prev.close) * 100;
        const isUp = change >= 0;
        document.getElementById("header-id").innerText = id;
        document.getElementById("header-name").innerText = stockNames[id] || id;
        document.getElementById("header-date").innerText = latest.date;
        document.getElementById("header-price").innerText = latest.close;
        document.getElementById("header-price").className = `text-5xl font-bold font-mono tracking-tighter ${isUp ? 'text-up' : 'text-down'}`;
        document.getElementById("header-change").innerHTML = `<span class="material-symbols-outlined text-xl mr-1">${isUp ? 'arrow_drop_up' : 'arrow_drop_down'}</span>${Math.abs(change).toFixed(2)}`;
        document.getElementById("header-change").className = `text-lg font-bold flex items-center ${isUp ? 'text-up' : 'text-down'}`;
        document.getElementById("header-pct").innerText = `${isUp ? '+' : ''}${pct.toFixed(2)}%`;
        document.getElementById("header-pct").className = `text-sm font-medium px-2 py-0.5 rounded ${isUp ? 'bg-up-light text-up' : 'bg-down-light text-down'}`;
    }

    function renderWatchlist() {
        document.getElementById("watchlist-container").innerHTML = watchlist.map(id => `
            <div onclick="loadStock('${id}')" class="p-3 rounded-xl cursor-pointer flex justify-between items-center ${id===currentStockId ? 'bg-indigo-600 text-white shadow-md' : 'bg-white hover:bg-slate-50 text-slate-700'}">
                <div class="flex items-center gap-3"><span class="font-bold font-mono text-sm">${id}</span><span class="text-xs opacity-80">${stockNames[id]||'ËºâÂÖ•‰∏≠...'}</span></div>
            </div>`).join('');
    }

    function handleAddStock(val) {
        if(val && !watchlist.includes(val)) { watchlist.unshift(val); loadStock(val); document.getElementById('stock-search').value = ""; }
    }
    
    function updateStatus(text, icon, spin) {
        document.getElementById("status-bar").innerHTML = `<span class="material-symbols-outlined text-sm ${spin}">${icon}</span><span class="text-xs text-slate-500">${text}</span>`;
    }

    function formatChange(id, val) {
        const el = document.getElementById(id);
        const num = parseFloat(val);
        if(isNaN(num)) { el.innerText = "--"; el.className = "font-bold text-slate-400"; return; }
        el.innerText = (num > 0 ? "+" : "") + val + "%";
        el.className = `font-bold ${num >= 0 ? 'text-up' : 'text-down'}`;
    }

    function resetFin(id) { document.getElementById(id).innerText = "--"; }
    function getSameMonthLastYear(dateStr) { const p = dateStr.split('-'); return `${parseInt(p[0]) - 1}-${p[1]}-${p[2]}`; }
    async function getJson(res) { return res.status === "fulfilled" ? await res.value.json() : null; }
    function getQuarterStr(dateStr) { const m = parseInt(dateStr.split('-')[1]); return m <= 3 ? "Q1" : m <= 6 ? "Q2" : m <= 9 ? "Q3" : "Q4"; }

    function loadMockData(id) {
        stockNames[id] = stockNames[id] || id; 
        renderHeader(id, [{close:100,open:99,date:'Ê®°Êì¨'}]);
        document.getElementById("header-name").innerText = stockNames[id];
        document.getElementById("fin-revenue").innerText = "200.5 ÂÑÑ";
        document.getElementById("fin-acc-yoy").innerText = "+25.4%";
        document.getElementById("fin-acc-yoy").className = "text-3xl font-bold font-mono tracking-tight text-up";
        document.getElementById("fin-margin").innerText = "54.2%";
        document.getElementById("fin-margin-ytd-growth").innerText = "‚ñ≤ 1.5%";
        document.getElementById("fin-margin-ytd-growth").className = "font-bold text-sm block text-up";
        document.getElementById("fin-margin-trend-val").innerText = "52.7% ‚Üí 54.2%";
        document.getElementById("fin-margin-target-q").innerText = "Q3";
        document.getElementById("fin-score").innerText = "79.6";
        document.getElementById("fin-score").className = "text-3xl font-bold font-mono tracking-tight text-indigo-600";
        document.getElementById("score-badge").classList.remove("hidden");
        document.getElementById("score-badge").innerText = "ÈÅîÊ®ô (79.6)";
        const news = [{title:`[Ê®°Êì¨] ${stockNames[id]} ÊØõÂà©ËàáÁáüÊî∂ÈõôÊàêÈï∑`, description:"...", date:"2025-12-01", tags:["financial","expansion"], source:"Mock", link:"#"}];
        analyzeAndRenderNews(news);
    }
</script>
</body>
</html>